<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Игра: Червяк собирает яблоки</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    font-family: Arial, sans-serif;
    background-color: #111;
  }
  #gameContainer {
    position: relative;
    width: 600px;
    height: 400px;
    margin: 20px auto;
    border: 4px solid #fff;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
  }
  canvas {
    display: block;
    width: 100%;
    height: 100%;
    background-color: #222;
  }
  #overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.7);
    flex-direction: column;
    color: #fff;
    font-size: 24px;
    z-index: 10;
  }
  #overlay button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 20px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background-color: #28a745;
    color: #fff;
  }
</style>
</head>
<body>
<div id="gameContainer">
  <canvas id="gameCanvas" width="600" height="400"></canvas>
  <div id="overlay">
    <div id="gameOverText"></div>
    <button id="restartBtn">Заново</button>
  </div>
</div>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const gameOverText = document.getElementById('gameOverText');
const restartBtn = document.getElementById('restartBtn');

let gameInterval = null;

function startGame() {
  overlay.style.display = 'none';

  const gridSize = 20;
  const width = canvas.width;
  const height = canvas.height;

  // Создаем текстуры в виде простых цветных квадратиков
  const snakeTexture = document.createElement('canvas');
  snakeTexture.width = gridSize;
  snakeTexture.height = gridSize;
  const sCtx = snakeTexture.getContext('2d');
  sCtx.fillStyle = '#00ff7f';
  sCtx.fillRect(0, 0, gridSize, gridSize);

  const appleTexture = document.createElement('canvas');
  appleTexture.width = gridSize;
  appleTexture.height = gridSize;
  const aCtx = appleTexture.getContext('2d');
  aCtx.fillStyle = 'red';
  aCtx.fillRect(0, 0, gridSize, gridSize);

  // Изначальные параметры
  let snake = [
    {x: Math.floor(width/2 / gridSize)*gridSize, y: Math.floor(height/2 / gridSize)*gridSize},
    {x: Math.floor(width/2 / gridSize)*gridSize - gridSize, y: Math.floor(height/2 / gridSize)*gridSize},
    {x: Math.floor(width/2 / gridSize)*gridSize - 2*gridSize, y: Math.floor(height/2 / gridSize)}
  ];
  let snakeLength = 3;
  let direction = {x: gridSize, y: 0};
  let apples = [];
  let score = 0;

  // Получаем рекорд из localStorage
  let record = localStorage.getItem('record') || 0;

  function spawnApple() {
    let apple;
    do {
      apple = {
        x: Math.floor(Math.random() * (width / gridSize)) * gridSize,
        y: Math.floor(Math.random() * (height / gridSize)) * gridSize
      };
    } while (
      apples.some(a => a.x === apple.x && a.y === apple.y) ||
      snake.some(s => s.x === apple.x && s.y === apple.y)
    );
    return apple;
  }

  for (let i=0; i<3; i++) {
    apples.push(spawnApple());
  }

  document.onkeydown = (e) => {
    if (e.key === 'ArrowUp' && direction.y === 0) {
      direction.x = 0; direction.y = -gridSize;
    } else if (e.key === 'ArrowDown' && direction.y === 0) {
      direction.x = 0; direction.y = gridSize;
    } else if (e.key === 'ArrowLeft' && direction.x === 0) {
      direction.x = -gridSize; direction.y = 0;
    } else if (e.key === 'ArrowRight' && direction.x === 0) {
      direction.x = gridSize; direction.y = 0;
    }
  };

  function gameLoop() {
    const newHead = {
      x: snake[0].x + direction.x,
      y: snake[0].y + direction.y
    };

    // Проверка столкновений
    if (
      newHead.x < 0 || newHead.x >= width ||
      newHead.y < 0 || newHead.y >= height ||
      snake.some(s => s.x === newHead.x && s.y === newHead.y)
    ) {
      endGame();
      return;
    }

    snake.unshift(newHead);

    // Проверка яблок
    let ateApple = false;
    for (let i=0; i<apples.length; i++) {
      if (apples[i].x === newHead.x && apples[i].y === newHead.y) {
        score++;
        if (score > record) {
          record = score;
          localStorage.setItem('record', record);
        }
        snakeLength++;
        apples[i] = spawnApple();
        ateApple = true;
        break;
      }
    }
    if (snake.length > snakeLength) {
      snake.pop();
    }

    // Рисуем
    ctx.fillStyle = '#222';
    ctx.fillRect(0, 0, width, height);

    for (let apple of apples) {
      ctx.drawImage(appleTexture, apple.x, apple.y);
    }
    for (let part of snake) {
      ctx.drawImage(snakeTexture, part.x, part.y);
    }

    ctx.fillStyle='white';
    ctx.font='20px Arial';
    ctx.fillText('Счет: ' + score, 10, 30);
    ctx.fillText('Рекорд: ' + record, 10, 60);
  }

  function endGame() {
    clearInterval(gameInterval);
    document.getElementById('gameOverText').innerHTML='Игра окончена!<br>Ваш счет: ' + score;
    overlay.style.display='flex';
  }

  gameInterval = setInterval(gameLoop, 200);

  // Обработка кнопки "Заново"
  document.getElementById('restartBtn').onclick = () => {
    clearInterval(gameInterval);
    startGame();
  };
}

document.getElementById('restartBtn').onclick = () => {
  clearInterval(gameInterval);
  startGame();
}

// Запускаем игру впервые
startGame();
</script>
</body>
</html>
